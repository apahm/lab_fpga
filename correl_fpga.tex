\chapter{Лабораторная работа №6. Реализация корреляционного устройства на ПЛИС}

\section{Быстрое преобразование Фурье}
	Выражение для дискретного преобразования Фурье имеет следующий вид:

\begin{align*}
f[k] &= \sum_{j=0}^{N-1} x[j]\left(e^{-2\pi i k/N}\right)^j\\
0 &\leq k < N
\end{align*}

\begin{figure}[h]
    \centering
    \noindent
	\begin{tikzpicture}% Example:
	  \draw[fill=white, draw=white] (-0.5, 0.7) rectangle (8, -7.7); 
	  \draw (0,0) node {$x[0]$};
	  \draw (0,-1) node {$x[2]$} ;
	  \draw (0,-2) node {$x[4]$} ;
	  \draw (0,-3) node {$x[6]$} ;
	
	  \draw (0,-4) node {$x[1]$} ;
	  \draw (0,-5) node {$x[3]$} ;
	  \draw (0,-6) node {$x[5]$} ;
	  \draw (0,-7) node {$x[7]$} ;
	
	  % arrow on the right of x's
	  \foreach \n in {0,...,7} {
	    \draw (0.5,-\n) circle(0.05)[fill=white]; 
	    \draw [-latex] (0.55,-\n) -- (1, -\n); 
	    \draw (1, -\n) -- (1.4, -\n); 
	  }
	
	  % blocks
	  \draw(1.4, 0.3) rectangle (4, -3.3); 
	  \draw(1.4, -3.7) rectangle (4, -7.3); 
	  \draw(2.7, -1.5) node[text centered, text width=2cm] {$N/2$-point DFT};
	  \draw(2.7, -5.5) node[text centered, text width=2cm] {$N/2$-point DFT};
	
	  % E's and O's 
	  \foreach \n in {0,...,7} {
	    \draw [-latex] (4,-\n) -- (4.95, -\n); 
	    \draw (5,-\n) circle(0.05)[fill=white]; 
	  }
	  \foreach \n in {0,...,3} {
	    \draw (4.9,-\n + 0.3) node {$E[\n]$};
	  }
	  \foreach \n in {0,...,3} {
	    \draw (4.9,-\n - 4 - 0.3) node {$O[\n]$};
	  }
	
	  % X's 
	  \foreach \n in {0,...,7} {
	    \draw (7,-\n) circle(0.05)[fill=white]; 
	    \draw (7.5,-\n) node {$X[\n]$};
	  }
	
	  % Connecting X and E
	  \foreach \n in {0,...,7} {
	    \draw [-latex] (5.05, -\n) -- (6.95, -\n);
	  }
	  \foreach \n in {0,...,3} {
	    \draw [-latex] (5.05, -\n) -- (6.95, -\n - 4);
	  }
	  \foreach \n in {0,...,3} {
	    \draw [-latex] (5.05, -\n-4) -- (6.95, -\n);
	  }
	
	  % W's
	  \foreach \n in {0,...,7} {
	    \draw (7.1,-\n - 0.3) node {\scriptsize $W_N^{\n}$};
	  }
	\end{tikzpicture}
\end{figure}

\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\textwidth]{image/fft_xilinx_fp.png}
	\caption{Временная диаграмма работы интерфейса AXI4-Stream}
	\label{fft_detailed_implem}
\end{figure}

Ядро БПФ предлагает четыре варианта архитектуры, обеспечивающие компромисс между ресурсами, которые будет занимать ядро на ПЛИС и пропускной способностью ядра (как правило, каждая архитектура предлагает двухкратную разницу в ресурсах по сравнению со следующей архитектурой): 
\begin{enumerate}
	\item Конвейерный потоковый ввод-вывод(Pipelined Streaming I/O) — обеспечивает непрерывную обработку данных. 
	\item Radix-4 — загружает и обрабатывает данные отдельно, используя итеративный подход. Оно меньше по размеру, чем конвейерное решение, но имеет большее время преобразования. 
	\item Radix-2 — использует тот же итеративный подход, что и Radix-4, но бабочка меньше. Это означает, что он меньше по размеру, чем решение Radix-4, но время преобразования больше. 
	\item Radix-2 Lite Burst I/O — основанный на архитектуре Radix-2, этот вариант использует подход с временным мультиплексированием к бабочке для еще меньшего ядра за счет более длительного времени преобразования.
\end{enumerate} 

Каждая архитектура имеет возможность естественного или бит-реверсного порядка выходных данных, в то время как входнные данные вводятся всегда в естественном порядке. Алгоритм БПФ переупорядочивает входные данные во время обработки таким образом, что данные, вводимые в естественном порядке, выводятся в бит-реверсном порядке. Заметим что вывод в естестенном порядке требует дополнительного времени преобразования и дополнительных ресурсов на ПЛИС. В архитектурах Radix-2 Burst I/O, Radix-2 Lite Burst I/O и Pipelined Streaming I/O бит-реверсный порядок битов легко вычислить, взяв индекс точки данных, записанный в двоичном виде, и реверсивное преобразование. порядок цифр. Следовательно, 0000, 0001, 0010, 0011, 0100,... (0, 1, 2, 3, 4,...) становятся 0000, 1000, 0100, 1100, 0010,... (0, 8, 4, 12, 2,...). В случае архитектуры Radix-4 реверсирование применяется к цифрам и поэтому называется реверсированием цифр. Цифра в Radix-4 состоит из двух битов. Следовательно, 0000, 0001, 0010, 0011, 0100,... (0, 1, 2, 3, 4,...) становятся 0000, 0100, 1000, 1100, 0001,... (0, 4, 8). , 12, 1,...), поскольку пары цифр меняются местами. 

\begin{figure}[h]
	\centering
	\includegraphics[width=0.9\textwidth]{image/axis_0.png}
	\caption{Временная диаграмма работы интерфейса AXI4-Stream}
	\label{axis}
\end{figure}

Рассмотрим порты ввода/вывода ядра. Основным используемым интерфейсом для взаимодействия с ядром является интерфейс AXI4-Stream. AXI4-Stream — это протокол, предназначенный для передачи однонаправленных данных(см.рис.~\ref{axis}). В AXI4-Stream биты ширины TDATA передаются за такт. Передача начинается, когда ведущее устройство(master) отправляет сигнал TVALID, а ведомое устройство(slave) отвечает, отправляя сигнал TREADY(этот механизм был рассмотрен выше, при рассмотрении интерфейса AXI4-Lite). В этот момент мастер начнет отправлять TDATA и TLAST (TUSER, если необходимо передать дополнительные данные, определяемые пользователем). TLAST сигнализирует о последнем слове потока. Таким образом, ведомое устройство(slave) продолжает потреблять входящие TDATA до тех пор, пока TLAST не будет установлен.

Для настройки ядра используется интерфейс AXI4-Stream \verb|S_AXIS_CONFIG|. 
Он состоит из следующих линий ввода/вывода: \verb|s_axis_config_tdata| - шина данных,
\verb|s_axis_config_tvalid|, \verb|s_axis_config_tready| - линии механизма "рукопожатий" в интерфейсе AXI4.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\textwidth]{image/FFT_AXIS_CONFIG.png}
	\caption{Временная диаграмма работы интерфейса AXI4-Stream}
	\label{fft_detailed_implem}
\end{figure}

\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\textwidth]{image/FFT_LENGTH.PNG}
	\caption{Временная диаграмма работы интерфейса AXI4-Stream}
	\label{fft_detailed_implem}
\end{figure}

\begin{enumerate}
	\item Размер точки преобразования: NFFT может быть размером максимального преобразования или любым меньшим размером точки. Например, 1024-точечное БПФ может вычислять размеры точек 1024, 512, 256 и т. д. Значение NFFT равно log2 (размер в пунктах). Это поле присутствует только для размера точки преобразования, настраиваемого во время выполнения.
	Размер точки преобразования можно установить в поле NFFT в канале конфигурации, если выбран параметр длины преобразования, настраиваемая во время выполнения. Допустимые настройки и соответствующие размеры преобразования представлены в таблице 3-18. Если введенное значение NFFT слишком велико, ядро устанавливает максимально доступный размер точки (выбранный в среде IDE). Если значение слишком мало, ядро устанавливает наименьший доступный размер точки: 64 для архитектуры Burst I/O Radix-4 и 8 для других архитектур.
	\item Длина циклического префикса: количество выборок с конца преобразования, которые изначально выводятся как циклический префикс, прежде чем будет выведено все преобразование. \verb|CP_LEN| может быть любым числом от нуля до единицы меньше размера пункта. Это поле присутствует только при вставке циклического префикса.
	\item Указывает, выполняется ли прямое преобразование БПФ или обратное преобразование БПФ. Когда \verb|FWD_INV| = 1, вычисляется прямое преобразование. Если \verb|FWD_INV| = 0, вычисляется обратное преобразование. Поле содержит 1 бит на канал данных БПФ, бит 0 (LSB) представляет канал 0, бит 1 представляет канал 1 и т. д.
	\item График масштабирования: для архитектур пакетного ввода-вывода график масштабирования задается двумя битами для каждого этапа, при этом масштабирование для первого этапа задается двумя младшими битами. Масштабирование может быть указано как 3, 2, 1 или 0, что представляет количество битов для сдвига. Примерный график масштабирования для N = 1024, пакетный ввод-вывод Radix-4: [1 0 2 3 2] (в порядке от последнего к первому этапу). Для N = 128, Radix-2 Burst I/O или Radix-2 Lite Burst I/O, один из возможных графиков масштабирования — [1 1 1 1 0 1 2] (в порядке от последнего к первому этапу). Для архитектуры Pipelined Streaming I/O график масштабирования определяется двумя битами для каждой пары этапов Radix-2, начиная с двух младших разрядов. Например, график масштабирования для N = 256 может быть [2 2 2 3]. Когда N не является степенью числа 4, максимальный прирост битов для последней стадии равен одному биту. Например, [0 2 2 2 2] или [1 2 2 2 2] являются допустимыми расписаниями масштабирования для N = 512, но [2 2 2 2 2] недействительны. Для этой длины преобразования два старших бита \verb|SCALE_SCH| могут быть только 00 или 01. Это поле доступно только с масштабированной арифметикой (не немасштабированной, блочной с плавающей запятой или одинарной точности с плавающей запятой).

\end{enumerate} 

Тип преобразования (прямое или обратное) и график масштабирования можно задавать покадрово, не прерывая обработку кадра. Как тип преобразования, так и график масштабирования могут быть установлены независимо для каждого канала БПФ в многоканальном ядре. Каждому каналу данных FFT назначено поле \verb|FWD_INV| и поле \verb|SCALE_SCH| в канале конфигурации. 
Установка поля \verb|FWD_INV| на 0 создает обратное БПФ, а установка поля \verb|FWD_INV| на 1 создает прямое преобразование. Расписание масштабирования не требуется (\verb|SCALE_SCH| игнорируется), когда ядро FFT настроено на обработку данных с плавающей запятой. Нормализация и масштабирование выполняются внутри для данных с плавающей запятой.

Поля конфигурации упаковываются в вектор \verb|s_axis_config_tdata| в следующем порядке (начиная с младшего разряда):

1. (необязательно) NFFT плюс заполнение 2. (необязательно) \verb|CP_LEN| плюс заполнение 3. FWD/INV 4. (необязательно) \verb|SCALE_SCH|

\begin{enumerate}
	\item \verb|event_frame_started| Этот сигнал события устанавливается в течение одного тактового цикла, когда ядро начинает обрабатывать новый кадр. Этот сигнал предназначен для подсчета кадров и синхронизации конфигурации ядра с конкретным кадром, если это необходимо.
	\item \verb|event_tlast_missing|
	Этот сигнал события устанавливается в течение одного тактового цикла, когда \verb|s_axis_data_tlast| имеет значение Low для последней входящей выборки данных кадра. Это показывает несоответствие конфигурации между ядром и вышестоящим источником данных в отношении размера кадра и указывает, что вышестоящий источник данных настроен на больший размер точки, чем ядро. Это вычисляется только тогда, когда ядро начинает обработку кадра, поэтому событие может отставать от отсутствующего \verb|s_axis_data_tlast| на большое количество тактов.
	\item \verb|event_tlast_unexpected|
	Этот сигнал события утверждается в течение одного тактового цикла, когда ядро видит \verb|s_axis_data_tlast| High для любой входящей выборки данных, которая не является последней в кадре. Это показывает несоответствие конфигурации между ядром и восходящим источником данных в отношении размера кадра и указывает, что восходящий источник данных настроен на меньший размер точки, чем ядро. Это вычисляется только тогда, когда ядро начинает обработку кадра, поэтому событие может отставать от неожиданного High на \verb|s_axis_data_tlast| на большое количество тактовых циклов. Если на \verb|s_axis_data_tlast| для кадра есть несколько неожиданных максимумов, то это утверждается для каждого из них.
	\item \verb|event_fft_overflow|
	Этот сигнал о событии устанавливается в каждом тактовом цикле, когда наблюдается переполнение в выборках данных, передаваемых на \verb|m_axis_data_tdata|. Переполнение БПФ возможно только при использовании масштабированной арифметики или ввода-вывода с плавающей запятой одинарной точности. Во всех других конфигурациях штифт удаляется из сердечника.
	\item \verb|event_data_in_channel_halt|
	Это событие подтверждается в каждом цикле, когда ядру требуются данные из канала ввода данных, а данные недоступны. • В режиме реального времени ядро продолжает обработку кадра, даже если он безвозвратно поврежден. • В режиме не в реальном времени основная обработка останавливается и продолжается только тогда, когда данные записываются в канал ввода данных. Рамка не повреждена. В обоих режимах событие остается подтвержденным до тех пор, пока данные не будут доступны в канале ввода данных.
	\item \verb|event_data_out_channel_halt|
	Это событие подтверждается в каждом цикле, когда ядру необходимо записать данные в канал вывода данных, но это невозможно, потому что буферы в канале заполнены. Когда это происходит, основная обработка останавливается, и вся деятельность останавливается до тех пор, пока в буферах канала не освободится место. Рамка не повреждена. Пин-код события доступен только в режиме не в реальном времени.
	\item \verb|event_status_channel_halt|
	Это событие подтверждается в каждом цикле, когда ядру необходимо записать данные в канал состояния, но это невозможно, потому что буферы в канале заполнены. Когда это происходит, основная обработка останавливается, и вся деятельность останавливается до тех пор, пока в буферах канала не появится свободное место. Кадр не поврежден. Пин-код события доступен только в режиме не в реальном времени.
\end{enumerate}

Ядро БПФ дополнительно принимает данные в формате одинарной точности IEEE-754 с 32-битными словами, состоящими из 1-битного знака, 8-битной экспоненты и 23-битной дроби. Конструкция слова соответствует конструкции ядра Xilinx Floating-Point Operator. Реализация полной плавающей запятой на FPGA может быть дорогостоящей с точки зрения требуемых ресурсов. Опция с плавающей запятой в ядре БПФ использует БПФ с фиксированной запятой более высокой точности для достижения шумовых характеристик, аналогичных полному БПФ с плавающей запятой, со значительно меньшими ресурсами. Рисунок 3-14 иллюстрирует два возможных уровня шумовых характеристик при выборе 24 или 25 битов для ширины фазового коэффициента. При увеличении ширины фазового коэффициента до 25 бит может потребоваться больше ресурсов в зависимости от целевого устройства.

На рис. 3-14 показано отношение разности среднеквадратичных значений между различными моделями и MATLAB® FFT с двойной точностью к пиковой амплитуде набора данных. Показанные модели представляют собой функцию MATLAB FFT одинарной точности (рассчитанную путем приведения входных данных к типу с плавающей запятой одинарной точности), ядро FFT с использованием 24-битной ширины фазового коэффициента и ядро FFT с использованием 25-битной фазы. ширина фактора. Для расчета сигнала ошибки в качестве входного сигнала использовался рандомизированный импульс (по величине и времени), при этом среднеквадратическая ошибка усреднялась по пяти запускам моделирования. При сравнении результатов со сторонними моделями, например, MATLAB, следует отметить, что для обеспечения совпадения результатов обычно требуется коэффициент масштабирования. Масштабный коэффициент зависит от данных, поскольку входные данные определяют уровень нормализации, требуемый до внутреннего ядра с фиксированной точкой. Поскольку ядро не обеспечивает этот коэффициент масштабирования в режиме с плавающей запятой, при необходимости можно применить масштабирование после вывода ядра.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\textwidth]{image/fft_config.png}
	\caption{Временная диаграмма работы интерфейса AXI4-Stream}
	\label{fft_config}
\end{figure}
	
\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\textwidth]{image/fft_implemetation.png}
	\caption{Временная диаграмма работы интерфейса AXI4-Stream}
	\label{fft_implemetation}
\end{figure}
	
\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\textwidth]{image/fft_config.png}
	\caption{Временная диаграмма работы интерфейса AXI4-Stream}
	\label{fft_detailed_implem}
\end{figure}
	
\section{Сигнал с линейной-частотной модуляцией}

Сигнал с линейной-частотной модуляцией определяется по следующей формуле:
\begin{equation}	
	s(t) = rect(\frac{t}{T}) \cdot \cos(2 \cdot \pi \cdot f_0 \cdot t + j \cdot \pi \cdot K \cdot t^{2}),
\end{equation}

где t - время в секундах, K-скорость изменения частоты во времени, T - длительность импульса, rect() - прямоугольное окно, \(f_0\) - несущая частота.

После прохождения через квадратурный демодулятор получаем следующий комплексный сигнал:

\begin{equation}	
	g(t) = rect(\frac{t}{T}) \cdot \exp(j \cdot \pi \cdot K \cdot t^{2})
\end{equation}

Действительная часть называется квадратурной
составляющей ЛЧМ-сигнал, и обозначается как \(Q(t)\), а мнимая 
синфазной составляющей ЛЧМ-сигнала, и обозначается как \(I(t)\):

\begin{equation}	
	Q(t) = rect(\frac{t}{T}) \cdot \cos(\pi \cdot K \cdot t^{2}),
\end{equation}

\begin{equation}	
	I(t) = rect(\frac{t}{T}) \cdot \sin(\pi \cdot K \cdot t^{2}).
\end{equation}

Важнейшими параметрами ЛЧМ-сигнала являются:

\begin{enumerate}
	\item Девиация частоты: 
\begin{equation}
	BW = |K| \cdot T, 
\end{equation}
измеряется в Гц.
	\item База: 
\begin{equation}
	B = |K| \cdot T^2, 
\end{equation}
безразмерная величина.
\end{enumerate}

Рассмотрим конкретный пример демодулированного ЛЧМ-сигнала. Пусть он имеет следующие параметры: частота дискретизации \(F_{D}\) = 1000 МГц, девиация частоты \(BW\) = 400 МГц, длительность сигнала \(T\) = 4 мкс. На рисунке ~\ref{fig:chirp_q} представлена квадратурная составляющая ЛЧМ-сигнала с приведёнными выше параметрами, а на рисунке ~\ref{fig:chirp_i} представлена синфазная составляющая ЛЧМ-сигнала с приведёнными выше параметрами.

\begin{figure}[h]
    \centering
    \noindent
    \begin{tikzpicture}
        \begin{axis}
            [
            RCS Plot,
            title={},
            height=0.4\textwidth,
            xlabel={Время, мкс},
            ylabel={Амплитуда, отсчётов},
            legend pos = south east
            ]
            \addplot table {Synopsis/data/third-party/lfm_im.dat};
            \addlegendentry{Q(t)};
            \addplot table {Synopsis/data/third-party/lfm_re.dat};
            \addlegendentry{I(t)};
        \end{axis}
    \end{tikzpicture}
    \caption{Квадратурная составляющая ЛЧМ сигнала}
    \label{fig:chirp_q}
\end{figure}

\begin{figure}[h]
    \centering
    \noindent
    \begin{tikzpicture}
        \begin{axis}
            [
            RCS Plot,
            title={},
            height=0.4\textwidth,
            xlabel={Время, мкс},
            ylabel={Амплитуда, отсчётов},
            legend pos = south east
            ]
            \addplot table {Synopsis/data/third-party/lfm_shift_im.dat};
            \addlegendentry{Q(t)};
            \addplot table {Synopsis/data/third-party/lfm_shift_re.dat};
            \addlegendentry{I(t)};
        \end{axis}
    \end{tikzpicture}
    \caption{Квадратурная составляющая ЛЧМ сигнала}
    \label{fig:chirp_q}
\end{figure}

\begin{figure}[h]
    \centering
    \noindent
    \begin{tikzpicture}
        \begin{axis}
            [
            RCS Plot,
            title={},
            height=0.4\textwidth,
            xlabel={Время, мкс},
            ylabel={Амплитуда, отсчётов},
            legend pos = south east
            ]
            \addplot table {Synopsis/data/third-party/lfm_shift_noise_im.dat};
            \addlegendentry{Q(t)};
            \addplot table {Synopsis/data/third-party/lfm_shift_noise_re.dat};
            \addlegendentry{I(t)};
        \end{axis}
    \end{tikzpicture}
    \caption{Квадратурная составляющая ЛЧМ сигнала}
    \label{fig:chirp_q}
\end{figure}

\begin{figure}[h]
    \centering
    \noindent
    \begin{tikzpicture}
        \begin{axis}
            [
            RCS Plot,
            title={},
            height=0.4\textwidth,
            xlabel={Время, мкс},
            ylabel={Амплитуда, отсчётов},
            legend pos = south east
            ]
            \addplot table {Synopsis/data/third-party/correl_re.dat};
            \addlegendentry{I(t)};
			\addplot table {Synopsis/data/third-party/correl_im.dat};
            \addlegendentry{I(t)};
        \end{axis}
    \end{tikzpicture}
    \caption{Синфазная составляющая ЛЧМ сигнала}
    \label{fig:chirp_i}
\end{figure}


\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\textwidth]{image/lfm_with_noise.png}
	\caption{Временная диаграмма работы интерфейса AXI4-Stream}
	\label{fft_result}
\end{figure}
	
\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\textwidth]{image/correl_with_noise.png}
	\caption{Временная диаграмма работы интерфейса AXI4-Stream}
	\label{fft_detailed_implem}
\end{figure}

\section{Практическая часть}

